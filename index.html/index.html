<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Professional Layout Designer - Anchor Fixed</title>
    <style>
        :root {
            --primary-blue: #0066ff;
            --bg-dark: #0f172a;
            --sidebar-bg: #ffffff;
            --text-main: #1e293b;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-dark); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        header { background: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 100; }
        header h2 { margin: 0; color: var(--primary-blue); font-size: 16px; }
        .upload-btn { background: var(--primary-blue); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        .main-layout { display: flex; flex: 1; }

        #viewport { position: relative; flex: 1; background: #020617; display: flex; align-items: center; justify-content: center; padding: 40px; cursor: crosshair; }
        #container { position: relative; border-radius: 4px; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        video { display: block; max-height: 65vh; max-width: 100%; border: 1px solid #334155; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Sidebar */
        .sidebar { width: 350px; background: var(--sidebar-bg); color: var(--text-main); padding: 15px; display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.2); overflow-y: auto; }
        .section-title { font-weight: bold; font-size: 11px; color: #64748b; margin: 15px 0 8px; border-bottom: 1px solid #e2e8f0; padding-bottom: 3px; }

        .tab-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .tab { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 8px; cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 11px; color: #475569; }
        .tab.active { background: var(--primary-blue); color: white; }

        .layer-box { display: flex; gap: 5px; margin-bottom: 10px; }
        .layer-btn { flex: 1; padding: 8px; border-radius: 4px; border: 2px solid #e2e8f0; background: white; cursor: pointer; font-size: 11px; font-weight: bold; }
        .layer-btn.active.lA { border-color: #00cc88; color: #00cc88; }
        .layer-btn.active.lB { border-color: #ff00ff; color: #ff00ff; }

        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-card { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; }
        .data-card label { display: block; font-size: 9px; color: #94a3b8; margin-bottom: 2px; }
        .data-card span { font-family: monospace; font-size: 18px; font-weight: bold; color: var(--primary-blue); }

        .summary-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px; }
        .summary-table th { background: #f1f5f9; padding: 5px; color: #475569; }
        .summary-table td { padding: 5px; border-bottom: 1px solid #f1f5f9; text-align: center; }

        .btn-clear { background: #ff4d4d; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 15px; width: 100%; }
        input[type="range"] { width: 100%; accent-color: var(--primary-blue); margin: 10px 0; }
    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center; gap: 12px;">
        <img src="unnamed.webp" style="height: 35px; width: auto; border-radius: 4px;" alt="Logo">
        <h2 style="margin: 0; color: var(--primary-blue); font-size: 16px;">
            BLUEPRINT <span style="color:#0f172a">PRO DESIGNER</span>
        </h2>
    </div>
    <label class="upload-btn">
        Upload Video
        <input type="file" id="file" hidden accept="video/*">
    </label>
</header>

<div class="main-layout">
    <div id="viewport">
        <div id="container">
            <video id="v"></video>
            <canvas id="c"></canvas>
        </div>
    </div>

    <div class="sidebar">
        <div class="section-title">SLIDE SELECTOR</div>
        <div class="tab-grid">
            <button class="tab active" onclick="changeSlide(1)">Slide 1</button>
            <button class="tab" onclick="changeSlide(2)">Slide 2</button>
            <button class="tab" onclick="changeSlide(3)">Slide 3</button>
            <button class="tab" onclick="changeSlide(4)">Slide 4</button>
            <button class="tab" onclick="changeSlide(5)">Slide 5</button>
            <button class="tab" onclick="changeSlide(6)">Slide 6</button>
        </div>

        <div id="layer-ui">
            <div class="section-title">LAYER SELECTOR (SLIDE 1)</div>
            <div class="layer-box">
                <button id="lA" class="layer-btn active lA" onclick="setLayer('A')">TEXT A</button>
                <button id="lB" class="layer-btn lB" onclick="setLayer('B')">TEXT B</button>
            </div>
        </div>

        <div class="section-title">COORDINATES (PX)</div>
        <div class="data-grid">
            <div class="data-card"><label>X (Anchor)</label><span id="outX">0</span></div>
            <div class="data-card"><label>Y (Anchor)</label><span id="outY">0</span></div>
            <div class="data-card"><label>WIDTH</label><span id="outW">0</span></div>
            <div class="data-card"><label>HEIGHT</label><span id="outH">0</span></div>
        </div>

        <div class="section-title">TIMELINE</div>
        <input type="range" id="seek" step="0.01" value="0">
        
        <div class="section-title">GLOBAL SUMMARY</div>
        <table class="summary-table">
            <thead><tr><th>S</th><th>L</th><th>X</th><th>Y</th><th>W</th><th>H</th></tr></thead>
            <tbody id="summary-body"></tbody>
        </table>

        <button class="btn-clear" onclick="clearCurrent()">CLEAR LAYER</button>
    </div>
</div>

<script>
    const v = document.getElementById('v'), c = document.getElementById('c'), ctx = c.getContext('2d');
    let currentSlide = 1, currentLayer = 'A';
    let data = Array.from({length: 7}, () => ({ A: {x:0,y:0,w:0,h:0,set:false}, B: {x:0,y:0,w:0,h:0,set:false} }));
    let isDrawing = false, startX, startY;

    document.getElementById('file').onchange = (e) => {
        const file = e.target.files[0];
        v.src = URL.createObjectURL(file);
        v.onloadedmetadata = () => {
            c.width = v.clientWidth; c.height = v.clientHeight;
            document.getElementById('seek').max = v.duration;
            updateSummary();
        };
    };

    document.getElementById('seek').oninput = () => v.currentTime = document.getElementById('seek').value;

    c.onmousedown = (e) => {
        isDrawing = true;
        const r = c.getBoundingClientRect();
        startX = e.clientX - r.left;
        startY = e.clientY - r.top;
    };

    c.onmousemove = (e) => {
        if(!isDrawing) return;
        const r = c.getBoundingClientRect();
        const curX = e.clientX - r.left;
        const curY = e.clientY - r.top;

        // منطق Anchor Point واقعی: پیدا کردن گوشه بالا-چپ فارغ از جهت حرکت ماوس
        const realX = Math.min(startX, curX);
        const realY = Math.min(startY, curY);
        const realW = Math.abs(curX - startX);
        const realH = Math.abs(curY - startY);

        const scX = v.videoWidth / c.width;
        const scY = v.videoHeight / c.height;

        drawAll(); // پاک کردن و کشیدن کادرهای قبلی
        
        // ترسیم کادر فعلی با استایل Anchor Point
        ctx.strokeStyle = currentLayer === 'A' ? "#00cc88" : "#ff00ff";
        ctx.lineWidth = 2;
        ctx.strokeRect(realX, realY, realW, realH);
        
        // ترسیم نقطه Anchor
        ctx.fillStyle = "white";
        ctx.fillRect(realX - 3, realY - 3, 6, 6);

        // ذخیره داده‌ها
        data[currentSlide][currentLayer] = {
            x: Math.round(realX * scX),
            y: Math.round(realY * scY),
            w: Math.round(realW * scX),
            h: Math.round(realH * scY),
            set: true
        };
        updateUI();
    };

    c.onmouseup = () => { isDrawing = false; updateSummary(); };

    function drawAll() {
        ctx.clearRect(0, 0, c.width, c.height);
        const scX = v.videoWidth / c.width, scY = v.videoHeight / c.height;
        ['A', 'B'].forEach(l => {
            const d = data[currentSlide][l];
            if(d.set) {
                ctx.strokeStyle = l === 'A' ? "#00cc88" : "#ff00ff";
                ctx.lineWidth = 1.5;
                ctx.strokeRect(d.x/scX, d.y/scY, d.w/scX, d.h/scY);
                ctx.fillStyle = l === 'A' ? "#00cc88" : "#ff00ff";
                ctx.fillRect((d.x/scX)-2, (d.y/scY)-2, 4, 4);
            }
        });
    }

    function changeSlide(n) {
        currentSlide = n;
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === n-1));
        document.getElementById('layer-ui').style.visibility = (n === 1) ? 'visible' : 'hidden';
        if(n !== 1) currentLayer = 'A';
        drawAll(); updateUI();
    }

    function setLayer(l) {
        currentLayer = l;
        document.getElementById('lA').classList.toggle('active', l==='A');
        document.getElementById('lB').classList.toggle('active', l==='B');
        updateUI();
    }

    function updateUI() {
        const d = data[currentSlide][currentLayer];
        document.getElementById('outX').innerText = d.x;
        document.getElementById('outY').innerText = d.y;
        document.getElementById('outW').innerText = d.w;
        document.getElementById('outH').innerText = d.h;
    }

    function updateSummary() {
        const body = document.getElementById('summary-body');
        body.innerHTML = "";
        for(let i=1; i<=6; i++) {
            ['A', 'B'].forEach(l => {
                if(i > 1 && l === 'B') return;
                const d = data[i][l];
                if(d.set) body.innerHTML += `<tr><td>${i}</td><td>${l}</td><td>${d.x}</td><td>${d.y}</td><td>${d.w}</td><td>${d.h}</td></tr>`;
            });
        }
    }

    function clearCurrent() {
        data[currentSlide][currentLayer] = {x:0,y:0,w:0,h:0,set:false};
        drawAll(); updateUI(); updateSummary();
    }
</script>
</body>
</html>

